<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tenant Dashboard</title>
  <link rel="stylesheet" href="../css/styles.css" />
</head>
<body>
  <div class="dashboard-container">
    <aside class="sidebar" aria-label="Sidebar Navigation">
      <h2>üè† JL HOSTELS</h2>
      <nav>
        <a href="#book-room">Book Room</a>
        <a href="#payments">Payments</a>
        <a href="#profile">Profile</a>
        <a href="../login.html" id="logout-btn">Logout</a>
      </nav>
    </aside>
    <div class="main-content">
      <section class="dashboard-section active" id="bookings-section">
        <h2>üìå My Bookings</h2>
        <table id="bookings-table">
          <thead>
            <tr><th>Hostel</th><th>Room Type</th><th>Amount</th><th>Status</th><th>Action</th></tr>
          </thead>
          <tbody>
            <!-- Bookings will be loaded here -->
          </tbody>
        </table>
      </section>
      <section class="dashboard-section" id="book-room-section">
        <h2>üõèÔ∏è Book a Room</h2>
        <div class="room-types-list" id="room-list">
          <!-- Rooms will be loaded here -->
        </div>
      </section>
      <section class="dashboard-section" id="payments-section">
        <h2>üí≥ Payment History</h2>
        <table>
          <thead>
            <tr><th>Date</th><th>Hostel</th><th>Amount</th><th>Status</th></tr>
          </thead>
          <tbody>
            <tr>
              <td>2025-07-01</td>
              <td>BLOCK A</td>
              <td>GHS 1000</td>
              <td><span class="badge confirmed">Paid</span></td>
            </tr>
          </tbody>
        </table>
      </section>
      <!-- Room Book Modal -->
      <div id="room-book-modal" class="modal hide" role="dialog" aria-modal="true" aria-labelledby="room-book-modal-title">
        <div class="modal-content">
          <h3 id="room-book-modal-title">Confirm Room Booking</h3>
          <p id="room-book-modal-details"></p>
          <button id="confirm-room-book-btn" class="action-btn">Confirm</button>
          <button id="close-room-book-modal" class="action-btn">Cancel</button>
        </div>
      </div>
      <!-- Payment Instructions Modal -->
      <div id="payment-instructions-modal" class="modal hide" role="dialog" aria-modal="true" aria-labelledby="payment-instructions-title">
        <div class="modal-content">
          <h3 id="payment-instructions-title">Payment Instructions</h3>
          <p>To complete your booking, please pay your hostel fees at the designated bank. After payment, present your bank receipt to the hostel admin for approval. Your booking status will be updated to <b>Confirmed</b> once the admin approves your payment.</p>
          <button id="close-payment-instructions-modal" class="action-btn">Close</button>
        </div>
      </div>
      <section class="dashboard-section" id="profile-section">
        <h2>üë§ Profile</h2>
        <p><strong>Name:</strong> <span id="profile-name-display"></span></p>
        <p><strong>Email:</strong> <span id="profile-email-display"></span></p>
        <button id="edit-profile-btn" class="action-btn">Edit Profile</button>
      </section>
    </div>
  </div>
  <div id="edit-profile-modal" class="modal hide">
    <form id="edit-profile-form">
      <label for="profile-name">Full Name</label>
      <input type="text" id="profile-name" name="profile-name" required />
      <label for="profile-email">Email</label>
      <input type="email" id="profile-email" name="profile-email" required />
      <button type="submit" class="action-btn">Save</button>
      <button type="button" id="close-profile-modal" class="action-btn">Cancel</button>
    </form>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      // Check authentication
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '../login.html';
        return;
      }

      // Load user profile
      const userId = localStorage.getItem('userId');
      try {
        const response = await fetch(`/api/bookings/user/${userId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) {
          throw new Error('Failed to load data');
        }
        
        const bookings = await response.json();
        renderBookings(bookings);
      } catch (error) {
        console.error('Error loading bookings:', error);
      }

      // Load hostels
      const campus = localStorage.getItem('campus');
      try {
        const response = await fetch(`/api/hostels?campus=${campus}`);
        const hostels = await response.json();
        renderHostels(hostels);
      } catch (error) {
        console.error('Error loading hostels:', error);
      }

      // Navigation
      const sectionMap = {
        'Book Room': 'book-room-section',
        'Payments': 'payments-section',
        'Profile': 'profile-section',
        'Logout': null
      };

      document.querySelectorAll('.sidebar nav a').forEach(function(link) {
        link.addEventListener('click', function(e) {
          if (link.id === 'logout-btn') {
            e.preventDefault();
            localStorage.clear();
            window.location.href = '../login.html';
            return;
          }
          
          if (link.getAttribute('href') === '../login.html') return;
          e.preventDefault();
          
          document.querySelectorAll('.dashboard-section').forEach(section => {
            section.style.display = 'none';
          });
          
          const sectionId = sectionMap[link.textContent.trim()];
          if (sectionId && document.getElementById(sectionId)) {
            document.getElementById(sectionId).style.display = 'block';
          }
        });
      });

      // Room booking
      let selectedRoom = '';
      let selectedHostelId = '';
      let selectedPrice = 0;

      function renderHostels(hostels) {
        const roomList = document.getElementById('room-list');
        roomList.innerHTML = '';
        
        hostels.forEach(hostel => {
          hostel.roomTypes.forEach(room => {
            if (room.available > 0) {
              const roomCard = document.createElement('div');
              roomCard.className = 'room-card';
              roomCard.innerHTML = `
                <img src="../images/${room.name.split(' ')[0]}-room.webp" alt="${room.name}" class="room-img" />
                <div class="room-info">
                  <h3>${room.name}</h3>
                  <p class="room-price">GHS ${room.price}</p>
                  <button class="action-btn book-room-btn" 
                    data-room="${room.name}" 
                    data-price="${room.price}"
                    data-hostel="${hostel._id}">
                    Book Room
                  </button>
                </div>
              `;
              roomList.appendChild(roomCard);
            }
          });
        });

        attachBookRoomListeners();
      }

      function renderBookings(bookings) {
        const bookingsTable = document.querySelector('#bookings-table tbody');
        bookingsTable.innerHTML = '';
        
        bookings.forEach(booking => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${booking.hostel?.name || 'N/A'}</td>
            <td>${booking.roomType}</td>
            <td>GHS ${booking.amount}</td>
            <td><span class="badge ${booking.status}">${booking.status}</span></td>
            <td><button class="action-btn">View</button></td>
          `;
          bookingsTable.appendChild(row);
        });
      }

      function attachBookRoomListeners() {
        const buttons = document.querySelectorAll('.book-room-btn');
        buttons.forEach((btn) => {
          btn.addEventListener('click', () => {
            selectedRoom = btn.dataset.room;
            selectedPrice = btn.dataset.price;
            selectedHostelId = btn.dataset.hostel;
            
            document.getElementById('room-book-modal-details').textContent =
              `Room Type: ${selectedRoom}, Price: GHS ${selectedPrice}`;
            document.getElementById('room-book-modal').classList.add('show');
            document.body.classList.add('modal-active');
          });
        });
      }

      document.getElementById('confirm-room-book-btn').addEventListener('click', async () => {
        try {
          const response = await fetch('/api/bookings', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              userId,
              hostelId: selectedHostelId,
              roomType: selectedRoom
            })
          });
          
          if (!response.ok) {
            throw new Error('Booking failed');
          }
          
          const booking = await response.json();
          
          document.getElementById('room-book-modal').classList.remove('show');
          document.body.classList.remove('modal-active');
          
          document.getElementById('payment-instructions-modal').classList.add('show');
          document.body.classList.add('modal-active');
          
          // Refresh bookings
          const bookingsResponse = await fetch(`/api/bookings/user/${userId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          const bookings = await bookingsResponse.json();
          renderBookings(bookings);
        } catch (error) {
          console.error('Booking error:', error);
          alert('Booking failed. Please try again.');
        }
      });

      // Modal controls
      document.getElementById('close-room-book-modal').addEventListener('click', () => {
        document.getElementById('room-book-modal').classList.remove('show');
        document.body.classList.remove('modal-active');
      });

      document.getElementById('close-payment-instructions-modal').addEventListener('click', () => {
        document.getElementById('payment-instructions-modal').classList.remove('show');
        document.body.classList.remove('modal-active');
      });

      // Profile section
      document.querySelector('#profile-section #edit-profile-btn').addEventListener('click', () => {
        document.getElementById('edit-profile-modal').classList.remove('hide');
      });

      document.getElementById('close-profile-modal').addEventListener('click', () => {
        document.getElementById('edit-profile-modal').classList.add('hide');
      });

      document.getElementById('edit-profile-form').addEventListener('submit', function(e) {
        e.preventDefault();
        document.getElementById('edit-profile-modal').classList.add('hide');
      });
    });
  </script>
</body>
</html>